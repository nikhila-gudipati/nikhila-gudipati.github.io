<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Planner Dashboard</title>
  <style>
    body {
      font-family: 'JetBrains Mono', monospace;
      margin: 0;
      padding: 20px;
      background-color: #F4F1DE;
      display: flex;
      justify-content: center;
    }
    .wrapper {
      width: 90%;
      max-width: 1400px;
    }
    h1, h2 {
      text-align: center;
      margin-bottom: 20px;
    }
    #categories-container, #fruits-container, #breakfast-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      padding-bottom: 20px;
    }
    .category, .fruit, .breakfast {
      display: flex;
      flex-direction: column;
    }
    .category-header, .fruit-header, .breakfast-header {
      border: 1px dotted #81B29A;
      padding: 5px 10px;
      display: inline-block;
      margin-bottom: 5px;
      position: relative;
    }
    .category-header h2, .fruit-header h2, .breakfast-header h2 {
      color: #477d63;
      font-weight: bold;
      margin: 0 0 3px 0;
    }
    .category-header p, .fruit-header p, .breakfast-header p  {
      margin: 0;
      font-weight: normal;
    }
    .meals-column, .fruits-column, .breakfast-column {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .meal-card, .fruit-card, .breakfast-card {
      background-color: #fff;
      border: 1px solid #ccc;
      padding: 10px;
      cursor: pointer;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
    }
    .meal-card.selected, .fruit-card.selected, .breakfast-card.selected {
      border: 2px solid #81B29A;
    }
    .meal-card h3, .fruit-card h3, .breakfast-card h3 {
      text-align: center;
      margin: 0 0 5px 0;
      font-size: 0.95em;
      font-weight: bold;
      color: #3D405B;
    }
    .meal-quadrants {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: auto auto;
      gap: 10px;
    }
    .meal-quadrants div span.heading {
      font-weight: bold;
      color: #E07A5F;
      display: block;
      font-size: 0.95em;
    }
    .meal-quadrants div span.ingredients {
      color: #3D405B;
      display: block;
      font-size: 0.8em;
      margin-top: 2px;
    }
    /* Fruit ingredients styling */
    .fruit-ingredients {
      font-size: 0.8em;
      color: #3D405B;
      text-align: center;
      line-height: 1.3;
    }
     /* Brekfast ingredients styling */
     .breakfast-ingredients {
      font-size: 0.8em;
      color: #3D405B;
      text-align: center;
      line-height: 1.3;
    }
    /* Desktop fruits grid */
    .fruits-column {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }
    .fruit-card {
      align-items: center;
      justify-content: flex-start;
    }
    /* Desktop breakfast grid */
    .breakfast-column {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 10px;
    }
    .breakfast-card {
      align-items: center;
      justify-content: flex-start;
    }
    /* Floating selected items counter */
    #selected-count {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: rgba(244, 241, 222, 0.9);
      border: 1px solid #81B29A;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: bold;
      z-index: 1000;
    }
    /* Grocery button styling */
    #generate-btn {
      display: inline-block;
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 1em;
      cursor: pointer;
      background-color: #81B29A;
      color: white;
      border: none;
      border-radius: 12px;
      box-shadow: 2px 2px 6px rgba(0,0,0,0.2);
      transition: all 0.2s ease-in-out;
    }
    #generate-btn:hover {
      transform: translateY(-2px);
      box-shadow: 4px 4px 8px rgba(0,0,0,0.3);
    }
    /* Grocery list table */
    #grocery-list {
      margin-top: 15px;
      border-collapse: collapse;
      width: 100%;
    }
    #grocery-list th, #grocery-list td {
      border: 1px solid #ccc;
      padding: 6px 10px;
      font-size: 0.9em;
    }
    #grocery-list th {
      background-color: #81B29A;
      color: white;
      text-align: left;
    }

    .day-selector {
      margin-top: 8px;
      display: none;
    }
    .day-selector select {
      width: 100%;
      padding: 4px 6px;   /* slightly smaller padding */
      border: 1px solid #81B29A;
      border-radius: 0;
      background: #fff;
      font-family: inherit;
      font-size: 0.75em;  /* smaller font size */
      color: #3D405B;
      cursor: pointer;
      appearance: none;
    }
    
    .day-selector select option {
      font-size: 0.75em;  /* shrink dropdown items too */
    }
    
    .day-selector select:hover,
    .day-selector select:focus {
      border-color: #3D405B;
      outline: none;
    }
    
    
    /*Week PLan Table*/
    .weekly-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    
    .weekly-table th,
    .weekly-table td {
      border: 1px solid #ccc;
      padding: 8px 12px;
      font-size: 0.9em;
      text-align: center;
    }
    
    .weekly-table th {
      background-color: #81B29A;
      color: #fff;
    }
    
    /* Mobile: dropdown style */
    @media (max-width: 768px) {
      #categories-container, #fruits-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }
      .category-header, .fruit-header, .breakfast-header {
        width: 80vw;
        cursor: pointer;
        padding-right: 30px;
        box-sizing: border-box;
      }
      .category-header::after, .fruit-header::after, .breakfast-header::after {
        content: "";
        position: absolute;
        right: 10px;
        top: 50%;
        width: 10px;
        height: 10px;
        border-bottom: 2px solid #81B29A;
        border-right: 2px solid #81B29A;
        transform: translateY(-50%) rotate(45deg);
      }
      .meals-column, .fruits-column, .breakfast-column {
        display: none;
        padding: 10px 0;
        gap: 10px;
        width: 80vw;
        margin: 0 auto;
      }
      .category.active .meals-column,
      .fruit.active .fruits-column, .breakfast.active .breakfast-column {
        display: grid;
        grid-template-columns: 1fr 1fr; /* 2 per row */
      }
      .meal-card, .fruit-card, .breakfast-card {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <h1>Meal Planner Dashboard</h1>
    <div id="categories-container"></div>
    <h2>Breakfast Plan</h2>
    <div id="breakfast-container"></div>
    <h2>Fruits Plan</h2>
    <div id="fruits-container"></div>
    <h2>Grocery List</h2>
    <button id="generate-btn">Generate Grocery List</button>
    <table id="grocery-list"></table>
    <p id="selected-count">Selected Meals: 0 / 7 | Selected Fruits: 0 / 7 | Selected Brealfast: 0/7</p>
    <div id="weekly-plan"></div>

  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script>
    const MAX_SELECTION = 7;
    let selectedMeals = [];
    let selectedFruits = [];
    let selectedBreakfast = [];

    const daysOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
    let dayAssignments = {}; 
    daysOfWeek.forEach(day => {
     dayAssignments[day] = { meals: [], breakfast: [] };
      });

    const categoriesContainer = document.getElementById("categories-container");
    const breakfastContainer = document.getElementById("breakfast-container");
    const fruitsContainer = document.getElementById("fruits-container");
    const selectedCount = document.getElementById("selected-count");
    const generateBtn = document.getElementById("generate-btn");
    const groceryListTable = document.getElementById("grocery-list");

    const mealSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRve-7FlrNw-LiD7lPCUyU4ZjQKa8W-vJI4s2utYk5d2rzXM6ZALKN3VBL-5znqoExocKY2e3QttAzS/pub?gid=1506494154&single=true&output=csv";
    const breakfastSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRve-7FlrNw-LiD7lPCUyU4ZjQKa8W-vJI4s2utYk5d2rzXM6ZALKN3VBL-5znqoExocKY2e3QttAzS/pub?gid=733060218&single=true&output=csv";
    const fruitSheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRve-7FlrNw-LiD7lPCUyU4ZjQKa8W-vJI4s2utYk5d2rzXM6ZALKN3VBL-5znqoExocKY2e3QttAzS/pub?gid=1442724610&single=true&output=csv";
    //Render weekly table
    function renderWeeklyPlan() {
      const container = document.getElementById("weekly-plan");
      container.innerHTML = "<h2>Weekly Plan</h2>";
    
      const table = document.createElement("table");
      table.classList.add("weekly-table");
    
      // Table header
      const header = document.createElement("tr");
      header.innerHTML = "<th>Day</th><th>Breakfast</th><th>Meal</th>";
      table.appendChild(header);
    
      // Each day row
      daysOfWeek.forEach(day => {
        const row = document.createElement("tr");
    
        const breakfastList = dayAssignments[day].breakfast.map(item => item.name).join(", ");
        const mealList = dayAssignments[day].meals.map(item => item.name).join(", ");
    
        row.innerHTML = `
          <td>${day}</td>
          <td>${breakfastList || "-"}</td>
          <td>${mealList || "-"}</td>
        `;
        table.appendChild(row);
      });
    
      container.appendChild(table);
    }
    
    
    // Load meals
    fetch(mealSheetUrl)
      .then(res => res.text())
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true }).data;
        const meals = data.map((row, idx) => ({
          category: row["Category"],
          description: row["Desc"] || "",
          name: row["Name"]?.trim() || `Meal ${idx + 1}`,
          ingredients: {
            protein: row["Protein"] ? row["Protein"].split(",").map(i => i.trim()).filter(Boolean) : [],
            fibre: row["Fibre"] ? row["Fibre"].split(",").map(i => i.trim()).filter(Boolean) : [],
            carb: row["Carb"] ? row["Carb"].split(",").map(i => i.trim()).filter(Boolean) : [],
            salad: row["Salad"] ? row["Salad"].split(",").map(i => i.trim()).filter(Boolean) : []
          }
        }));
        renderMeals(meals);
      })
      .catch(err => console.error("Error fetching meals:", err));

    function renderMeals(meals) {
      const categories = [...new Set(meals.map(m => m.category))];
      categoriesContainer.innerHTML = "";
      categories.forEach(cat => {
        const catDiv = document.createElement("div");
        catDiv.classList.add("category");

        const catMeals = meals.filter(m => m.category === cat);
        const catDesc = catMeals[0]?.description || "";

        const catHeader = document.createElement("div");
        catHeader.classList.add("category-header");
        catHeader.innerHTML = `<h2>${cat}</h2>${catDesc ? `<p>${catDesc}</p>` : ""}`;
        catHeader.addEventListener("click", () => catDiv.classList.toggle("active"));
        catDiv.appendChild(catHeader);

        const mealsCol = document.createElement("div");
        mealsCol.classList.add("meals-column");

        catMeals.forEach(meal => {
          const card = document.createElement("div");
          card.classList.add("meal-card");
          card.innerHTML = `
            <h3>${meal.name}</h3>
            <div class="meal-quadrants">
              <div>${meal.ingredients.protein.length ? `<span class="heading">Protein</span><span class="ingredients">${meal.ingredients.protein.join(", ")}</span>` : ""}</div>
              <div>${meal.ingredients.fibre.length ? `<span class="heading">Fibre</span><span class="ingredients">${meal.ingredients.fibre.join(", ")}</span>` : ""}</div>
              <div>${meal.ingredients.carb.length ? `<span class="heading">Carb</span><span class="ingredients">${meal.ingredients.carb.join(", ")}</span>` : ""}</div>
              <div>${meal.ingredients.salad.length ? `<span class="heading">Salad</span><span class="ingredients">${meal.ingredients.salad.join(", ")}</span>` : ""}</div>
            </div>
            <div class="day-selector">
              <select>
                <option value="">Assign</option>
                ${daysOfWeek.map(day => `<option value="${day}">${day}</option>`).join("")}
              </select>
            </div>
          `;

          card.addEventListener("click", () => toggleMeal(card, meal));
          mealsCol.appendChild(card);
        });

        catDiv.appendChild(mealsCol);
        categoriesContainer.appendChild(catDiv);
      });
    }

    function toggleMeal(card, meal) {
      const dropdown = card.querySelector(".day-selector");
      const select = dropdown.querySelector("select");
    
      if (card.classList.contains("selected")) {
        card.classList.remove("selected");
        dropdown.style.display = "none";
        select.value = "";
        selectedMeals = selectedMeals.filter(m => m.name !== meal.name);
        daysOfWeek.forEach(day => {
          dayAssignments[day].meals = dayAssignments[day].meals.filter(m => m.name !== meal.name);
        });
      } else {
        if (selectedMeals.length < MAX_SELECTION) {
          card.classList.add("selected");
          selectedMeals.push(meal);
          dropdown.style.display = "block";
    
          select.onchange = () => {
            const chosenDay = select.value;
            if (chosenDay) {
              daysOfWeek.forEach(day => {
                dayAssignments[day].meals = dayAssignments[day].meals.filter(m => m.name !== meal.name);
              });
              dayAssignments[chosenDay].meals.push(meal);
              renderWeeklyPlan();
            }
          };
        } else {
          alert(`You can select maximum ${MAX_SELECTION} meals.`);
        }
      }
      updateCounter();
      renderWeeklyPlan();
    }
    

    // Load breakfast
    fetch(breakfastSheetUrl)
      .then(res => res.text())
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true }).data;
        const breakfast = data
          .map((row, idx) => ({
            name: row["BName"]?.trim() || `Breakfast ${idx + 1}`,
            ingredients: row["Ingredients"] 
              ? row["Ingredients"].split(",").map(f => f.trim()).filter(Boolean)
              : []
          }))
          .filter(f => f.ingredients.length);

        renderBreakfast(breakfast);
      })
      .catch(err => console.error("Error fetching breakfast:", err));

    function renderBreakfast(breakfast) {
      breakfastContainer.innerHTML = "";
      const breakfastDiv = document.createElement("div");
      breakfastDiv.classList.add("breakfast");

      const breakfastHeader = document.createElement("div");
      breakfastHeader.classList.add("breakfast-header");
      breakfastHeader.innerHTML = `<h2>Breakfast</h2>`;
      breakfastHeader.addEventListener("click", () => breakfastDiv.classList.toggle("active"));
      breakfastDiv.appendChild(breakfastHeader);

      const breakfastCol = document.createElement("div");
      breakfastCol.classList.add("breakfast-column");

      breakfast.forEach((breakfast, index) => {
        const card = document.createElement("div");
        card.classList.add("breakfast-card");
        card.innerHTML = `
          <h3>${breakfast.name}</h3>
          <div class="breakfast-ingredients">${breakfast.ingredients.join("<br>")}</div>
          <div class="day-selector">
          <select>
            <option value=""> Assign </option>
            ${daysOfWeek.map(day => `<option value="${day}">${day}</option>`).join("")}
          </select>
        </div>

        `;
        card.addEventListener("click", () => toggleBreakfast(card, breakfast));
        breakfastCol.appendChild(card);
      });

      breakfastDiv.appendChild(breakfastCol);
      breakfastContainer.appendChild(breakfastDiv);
    }

    function toggleBreakfast(card, item) {
      const dropdown = card.querySelector(".day-selector");
      const select = dropdown.querySelector("select");
    
      if (card.classList.contains("selected")) {
        // Deselect
        card.classList.remove("selected");
        dropdown.style.display = "none";
        select.value = "";
        selectedBreakfast = selectedBreakfast.filter(b => b.name !== item.name);
    
        // Remove from all days
        daysOfWeek.forEach(day => {
          dayAssignments[day].breakfast = dayAssignments[day].breakfast.filter(b => b.name !== item.name);
        });
      } else {
        if (selectedBreakfast.length < MAX_SELECTION) {
          // Select
          card.classList.add("selected");
          selectedBreakfast.push(item);
          dropdown.style.display = "block";
    
          // Assign day when user picks from dropdown
          select.onchange = () => {
            const chosenDay = select.value;
            if (chosenDay) {
              // Remove from other days before reassigning
              daysOfWeek.forEach(day => {
                dayAssignments[day].breakfast = dayAssignments[day].breakfast.filter(b => b.name !== item.name);
              });
              dayAssignments[chosenDay].breakfast.push(item);
              renderWeeklyPlan();
            }
          };
        } else {
          alert(`You can select maximum ${MAX_SELECTION} breakfast items.`);
        }
      }
      updateCounter();
      renderWeeklyPlan();
    }
    
    

    // Load fruits
    fetch(fruitSheetUrl)
      .then(res => res.text())
      .then(csvText => {
        const data = Papa.parse(csvText, { header: true }).data;
        const fruits = data
          .map((row, idx) => ({
            ingredients: row["Fruits"] 
              ? row["Fruits"].split(",").map(f => f.trim()).filter(Boolean)
              : []
          }))
          .filter(f => f.ingredients.length);
        renderFruits(fruits);
      })
      .catch(err => console.error("Error fetching fruits:", err));

    function renderFruits(fruits) {
      fruitsContainer.innerHTML = "";
      const fruitDiv = document.createElement("div");
      fruitDiv.classList.add("fruit");

      const fruitHeader = document.createElement("div");
      fruitHeader.classList.add("fruit-header");
      fruitHeader.innerHTML = `<h2>Fruits</h2>`;
      fruitHeader.addEventListener("click", () => fruitDiv.classList.toggle("active"));
      fruitDiv.appendChild(fruitHeader);

      const fruitsCol = document.createElement("div");
      fruitsCol.classList.add("fruits-column");

      fruits.forEach((fruit, index) => {
        const card = document.createElement("div");
        card.classList.add("fruit-card");
        card.innerHTML = `
          <h3>Fruit ${index + 1}</h3>
          <div class="fruit-ingredients">${fruit.ingredients.join("<br>")}</div>
        `;
        card.addEventListener("click", () => toggleFruit(card, fruit));
        fruitsCol.appendChild(card);
      });

      fruitDiv.appendChild(fruitsCol);
      fruitsContainer.appendChild(fruitDiv);
    }

    function toggleFruit(card, fruit) {
      if (card.classList.contains("selected")) {
        card.classList.remove("selected");
        selectedFruits = selectedFruits.filter(f => f !== fruit);
      } else {
        if (selectedFruits.length < MAX_SELECTION) {
          card.classList.add("selected");
          selectedFruits.push(fruit);
        } else {
          alert(`You can select maximum ${MAX_SELECTION} fruits.`);
        }
      }
      updateCounter();
    }

    function updateCounter() {
      selectedCount.textContent = `Selected Meals: ${selectedMeals.length} / ${MAX_SELECTION} | Selected Fruits: ${selectedFruits.length} / ${MAX_SELECTION} | Selected Breakfast: ${selectedBreakfast.length} / ${MAX_SELECTION}`;
    }

    // Generate grocery list
    generateBtn.addEventListener("click", () => {
      const ingredientMap = {};

      // Meals
      selectedMeals.forEach(meal => {
        Object.values(meal.ingredients).forEach(items => {
          items.forEach(item => {
            if (!ingredientMap[item]) {
              ingredientMap[item] = { count: 0, meals: [] };
            }
            ingredientMap[item].count++;
            ingredientMap[item].meals.push(meal.name);
          });
        });
      });

      // Breakfast
      selectedBreakfast.forEach(breakfast => {
        breakfast.ingredients.forEach(item => {
          if (!ingredientMap[item]) {
            ingredientMap[item] = { count: 0, meals: [] };
          }
          ingredientMap[item].count++;
          ingredientMap[item].meals.push(breakfast.name);
          });
        });

      // Fruits
      selectedFruits.forEach(fruit => {
        fruit.ingredients.forEach(item => {
          if (!ingredientMap[item]) {
            ingredientMap[item] = { count: 0, meals: [] };
          }
          ingredientMap[item].count++;
          ingredientMap[item].meals.push("Fruit");
        });
      });

      groceryListTable.innerHTML = "";
      if (Object.keys(ingredientMap).length > 0) {
        const headerRow = document.createElement("tr");
        headerRow.innerHTML = "<th>Ingredient</th><th>Count</th><th>Meals/Fruits</th>";
        groceryListTable.appendChild(headerRow);

        Object.keys(ingredientMap).sort().forEach(ing => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${ing}</td>
            <td>${ingredientMap[ing].count}</td>
            <td>${ingredientMap[ing].meals.join(", ")}</td>
          `;
          groceryListTable.appendChild(row);
        });
      }
    });
  </script>
</body>
</html>
